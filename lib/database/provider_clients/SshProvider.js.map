{"version":3,"sources":["../../../src/database/provider_clients/SshProvider.js"],"names":["SshProvider","connect","database","connecting","Error","connection","disconnect","server","config","ssh","sshTunnel","logger","debug","address","port","localHost","localPort","driver","clients","client","Promise","all","handleSSHError","err","error","resolve","reject","on"],"mappings":";;;;;;AACA;;;;AACA;;;;;;;;AAGe,MAAMA,WAAN,gCAAuC;AAC9CC,SAAN,GAAgB;AAAA;;AAAA;AACd,UAAI,MAAKC,QAAL,CAAcC,UAAlB,EAA8B;AAC5B,cAAM,IAAIC,KAAJ,CACJ,uFADI,CAAN;AAGD;;AAED,UAAI,MAAKF,QAAL,CAAcC,UAAlB,EAA8B;AAC5B,cAAM,IAAIC,KAAJ,CACJ,yFADI,CAAN;AAGD;;AAED,UAAI;AACF,cAAKF,QAAL,CAAcC,UAAd,GAA2B,IAA3B;;AAEA;AACA,YAAI,MAAKD,QAAL,CAAcG,UAAlB,EAA8B;AAC5B,gBAAKH,QAAL,CAAcG,UAAd,CAAyBC,UAAzB;AACD;;AAED;AACA,YAAI,MAAKC,MAAL,CAAYC,MAAZ,CAAmBC,GAAnB,IAA0B,CAAC,MAAKF,MAAL,CAAYG,SAA3C,EAAsD;AACpDC,mBAASC,KAAT,CAAe,qBAAf;AACA,gBAAKL,MAAL,CAAYG,SAAZ,GAAwB,MAAM,sBAAO,MAAKH,MAAL,CAAYC,MAAnB,CAA9B;;AAEA,gBAAM,EAAEK,OAAF,EAAWC,IAAX,KAAoB,MAAKP,MAAL,CAAYG,SAAZ,CAAsBG,OAAtB,EAA1B;AACAF,mBAASC,KAAT,CACE,+CADF,EAEEC,OAFF,EAGEC,IAHF;;AAMA,gBAAKP,MAAL,CAAYC,MAAZ,CAAmBO,SAAnB,GAA+BF,OAA/B;AACA,gBAAKN,MAAL,CAAYC,MAAZ,CAAmBQ,SAAnB,GAA+BF,IAA/B;AACD;;AAED,cAAMG,SAASC,QAAQ,MAAKX,MAAL,CAAYC,MAAZ,CAAmBW,MAA3B,CAAf;;AAEA,cAAM,CAACd,UAAD,IAAe,MAAMe,QAAQC,GAAR,CAAY,CACrCJ,OAAO,MAAKV,MAAZ,EAAoB,MAAKL,QAAzB,CADqC,EAErC,MAAKoB,cAAL,CAAoB,MAAKf,MAAL,CAAYG,SAAhC,CAFqC,CAAZ,CAA3B;;AAKA,cAAKR,QAAL,CAAcG,UAAd,GAA2BA,UAA3B;AACD,OAhCD,CAgCE,OAAOkB,GAAP,EAAY;AACZZ,iBAASa,KAAT,CAAe,qBAAf,EAAsCD,GAAtC;AACA,cAAKjB,UAAL;AACA,cAAMiB,GAAN;AACD,OApCD,SAoCU;AACR,cAAKrB,QAAL,CAAcC,UAAd,GAA2B,KAA3B;AACD;AAnDa;AAoDf;;AAEDmB,iBAAeZ,SAAf,EAA0C;AACxC,WAAO,IAAIU,OAAJ,CAAY,CAACK,OAAD,EAAUC,MAAV,KAAqB;AACtC,UAAI,CAAChB,SAAL,EAAgB;AACd,eAAOe,QAAQ,IAAR,CAAP;AACD;;AAEDf,gBAAUiB,EAAV,CAAa,SAAb,EAAwBF,OAAxB;AACAf,gBAAUiB,EAAV,CAAa,OAAb,EAAsBH,SAAS;AAC7Bb,iBAASa,KAAT,CAAe,cAAf,EAA+BA,KAA/B;AACAE,eAAOF,KAAP;AACD,OAHD;;AAKA,aAAOC,QAAQ,IAAR,CAAP;AACD,KAZM,CAAP;AAaD;AArEmD;kBAAjCzB,W","file":"SshProvider.js","sourcesContent":["// @flow\nimport BaseProvider from './BaseProvider';\nimport Tunnel from '../Tunnel';\nimport type { sshTunnelType } from '../Tunnel';\n\nexport default class SshProvider extends BaseProvider {\n  async connect() {\n    if (this.database.connecting) {\n      throw new Error(\n        'There is already a connection in progress for this server. Aborting this new request.'\n      );\n    }\n\n    if (this.database.connecting) {\n      throw new Error(\n        'There is already a connection in progress for this database. Aborting this new request.'\n      );\n    }\n\n    try {\n      this.database.connecting = true;\n\n      // terminate any previous lost connection for this DB\n      if (this.database.connection) {\n        this.database.connection.disconnect();\n      }\n\n      // reuse existing tunnel\n      if (this.server.config.ssh && !this.server.sshTunnel) {\n        logger().debug('creating ssh tunnel');\n        this.server.sshTunnel = await Tunnel(this.server.config);\n\n        const { address, port } = this.server.sshTunnel.address();\n        logger().debug(\n          'ssh forwarding through local connection %s:%d',\n          address,\n          port\n        );\n\n        this.server.config.localHost = address;\n        this.server.config.localPort = port;\n      }\n\n      const driver = clients[this.server.config.client];\n\n      const [connection] = await Promise.all([\n        driver(this.server, this.database),\n        this.handleSSHError(this.server.sshTunnel)\n      ]);\n\n      this.database.connection = connection;\n    } catch (err) {\n      logger().error('Connection error %j', err);\n      this.disconnect();\n      throw err;\n    } finally {\n      this.database.connecting = false;\n    }\n  }\n\n  handleSSHError(sshTunnel?: sshTunnelType) {\n    return new Promise((resolve, reject) => {\n      if (!sshTunnel) {\n        return resolve(true);\n      }\n\n      sshTunnel.on('success', resolve);\n      sshTunnel.on('error', error => {\n        logger().error('ssh error %j', error);\n        reject(error);\n      });\n\n      return resolve(true);\n    });\n  }\n}\n"]}