{"version":3,"sources":["../../src/core/Formatter.js"],"names":["trimEnd","tokenTypes","Indentation","InlineBlock","Params","Formatter","constructor","cfg","tokenizer","indentation","indent","inlineBlock","params","previousReservedWord","format","query","tokens","tokenize","formattedQuery","getFormattedQueryFromTokens","trim","forEach","token","index","type","WHITESPACE","LINE_COMMENT","formatLineComment","BLOCK_COMMENT","formatBlockComment","RESERVED_TOPLEVEL","formatToplevelReservedWord","RESERVED_NEWLINE","formatNewlineReservedWord","RESERVED","formatWithSpaces","OPEN_PAREN","formatOpeningParentheses","CLOSE_PAREN","formatClosingParentheses","PLACEHOLDER","formatPlaceholder","value","formatComma","formatWithSpaceAfter","formatWithoutSpaces","addNewline","indentComment","comment","replace","getIndent","decreaseTopLevel","increaseToplevel","equalizeWhitespace","string","previousToken","beginIfPossible","isActive","increaseBlockLevel","end","decreaseBlockLevel","get","test"],"mappings":"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","file":"Formatter.js","sourcesContent":["import trimEnd from 'lodash/trimEnd';\nimport tokenTypes from './tokenTypes';\nimport Indentation from './Indentation';\nimport InlineBlock from './InlineBlock';\nimport Params from './Params';\n\nexport default class Formatter {\n  /**\n   * @param {Object} cfg\n   *   @param {Object} cfg.indent\n   *   @param {Object} cfg.params\n   * @param {Tokenizer} tokenizer\n   */\n  constructor(cfg, tokenizer) {\n    this.cfg = cfg || {};\n    this.indentation = new Indentation(this.cfg.indent);\n    this.inlineBlock = new InlineBlock();\n    this.params = new Params(this.cfg.params);\n    this.tokenizer = tokenizer;\n    this.previousReservedWord = {};\n  }\n\n  /**\n   * Formats whitespaces in a SQL string to make it easier to read.\n   *\n   * @param {String} query The SQL query string\n   * @return {String} formatted query\n   */\n  format(query) {\n    const tokens = this.tokenizer.tokenize(query);\n    const formattedQuery = this.getFormattedQueryFromTokens(tokens);\n\n    return formattedQuery.trim();\n  }\n\n  getFormattedQueryFromTokens(tokens) {\n    let formattedQuery = '';\n\n    tokens.forEach((token, index) => {\n      if (token.type === tokenTypes.WHITESPACE) {\n      } else if (token.type === tokenTypes.LINE_COMMENT) {\n        formattedQuery = this.formatLineComment(token, formattedQuery);\n      } else if (token.type === tokenTypes.BLOCK_COMMENT) {\n        formattedQuery = this.formatBlockComment(token, formattedQuery);\n      } else if (token.type === tokenTypes.RESERVED_TOPLEVEL) {\n        formattedQuery = this.formatToplevelReservedWord(token, formattedQuery);\n        this.previousReservedWord = token;\n      } else if (token.type === tokenTypes.RESERVED_NEWLINE) {\n        formattedQuery = this.formatNewlineReservedWord(token, formattedQuery);\n        this.previousReservedWord = token;\n      } else if (token.type === tokenTypes.RESERVED) {\n        formattedQuery = this.formatWithSpaces(token, formattedQuery);\n        this.previousReservedWord = token;\n      } else if (token.type === tokenTypes.OPEN_PAREN) {\n        formattedQuery = this.formatOpeningParentheses(\n          tokens,\n          index,\n          formattedQuery\n        );\n      } else if (token.type === tokenTypes.CLOSE_PAREN) {\n        formattedQuery = this.formatClosingParentheses(token, formattedQuery);\n      } else if (token.type === tokenTypes.PLACEHOLDER) {\n        formattedQuery = this.formatPlaceholder(token, formattedQuery);\n      } else if (token.value === ',') {\n        formattedQuery = this.formatComma(token, formattedQuery);\n      } else if (token.value === ':') {\n        formattedQuery = this.formatWithSpaceAfter(token, formattedQuery);\n      } else if (token.value === '.' || token.value === ';') {\n        formattedQuery = this.formatWithoutSpaces(token, formattedQuery);\n      } else {\n        formattedQuery = this.formatWithSpaces(token, formattedQuery);\n      }\n    });\n    return formattedQuery;\n  }\n\n  formatLineComment(token, query) {\n    return this.addNewline(query + token.value);\n  }\n\n  formatBlockComment(token, query) {\n    return this.addNewline(\n      this.addNewline(query) + this.indentComment(token.value)\n    );\n  }\n\n  indentComment(comment) {\n    return comment.replace(/\\n/g, `\\n${this.indentation.getIndent()}`);\n  }\n\n  formatToplevelReservedWord(token, query) {\n    this.indentation.decreaseTopLevel();\n\n    query = this.addNewline(query);\n\n    this.indentation.increaseToplevel();\n\n    query += this.equalizeWhitespace(token.value);\n    return this.addNewline(query);\n  }\n\n  formatNewlineReservedWord(token, query) {\n    return `${this.addNewline(query) + this.equalizeWhitespace(token.value)} `;\n  }\n\n  // Replace any sequence of whitespace characters with single space\n  equalizeWhitespace(string) {\n    return string.replace(/\\s+/g, ' ');\n  }\n\n  // Opening parentheses increase the block indent level and start a new line\n  formatOpeningParentheses(tokens, index, query) {\n    // Take out the preceding space unless there was whitespace there in the original query or another opening parens\n    const previousToken = tokens[index - 1];\n    if (\n      previousToken &&\n      previousToken.type !== tokenTypes.WHITESPACE &&\n      previousToken.type !== tokenTypes.OPEN_PAREN\n    ) {\n      query = trimEnd(query);\n    }\n    query += tokens[index].value;\n\n    this.inlineBlock.beginIfPossible(tokens, index);\n\n    if (!this.inlineBlock.isActive()) {\n      this.indentation.increaseBlockLevel();\n      query = this.addNewline(query);\n    }\n    return query;\n  }\n\n  // Closing parentheses decrease the block indent level\n  formatClosingParentheses(token, query) {\n    if (this.inlineBlock.isActive()) {\n      this.inlineBlock.end();\n      return this.formatWithSpaceAfter(token, query);\n    }\n\n    this.indentation.decreaseBlockLevel();\n    return this.formatWithSpaces(token, this.addNewline(query));\n  }\n\n  formatPlaceholder(token, query) {\n    return `${query + this.params.get(token)} `;\n  }\n\n  // Commas start a new line (unless within inline parentheses or SQL \"LIMIT\" clause)\n  formatComma(token, query) {\n    query = `${trimEnd(query) + token.value} `;\n\n    if (this.inlineBlock.isActive()) {\n      return query;\n    } else if (/^LIMIT$/i.test(this.previousReservedWord.value)) {\n      return query;\n    }\n\n    return this.addNewline(query);\n  }\n\n  formatWithSpaceAfter(token, query) {\n    return `${trimEnd(query) + token.value} `;\n  }\n\n  formatWithoutSpaces(token, query) {\n    return trimEnd(query) + token.value;\n  }\n\n  formatWithSpaces(token, query) {\n    return `${query + token.value} `;\n  }\n\n  addNewline(query) {\n    return `${trimEnd(query)}\\n${this.indentation.getIndent()}`;\n  }\n}\n"]}