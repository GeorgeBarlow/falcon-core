{"version":3,"sources":["../../../src/database/provider_clients/MysqlProviderFactory.js"],"names":["server","database","databaseConfig","configDatabase","logger","debug","connection","pool","mysql","createPool","provider","MysqlProvider","driverExecuteQuery","query","MysqlProviderFactory","BaseProvider","constructor","mysqlErrors","EMPTY_QUERY","CONNECTION_LOST","disconnect","end","runWithConnection","run","rejected","Promise","resolve","reject","rejectErr","err","getConnection","errPool","_connection","on","error","release","getRealError","_protocol","_fatalError","queryArgs","runQuery","params","data","fields","code","listTables","sql","then","res","listViews","listRoutines","map","routineName","row","routine_name","routineType","routine_type","listTableColumns","table","columnName","column_name","dataType","data_type","listTableTriggers","trigger_name","listTableIndexes","Key_name","listSchemas","getTableReferences","referenced_table_name","getTableColumns","constraintName","constraint_name","referencedTable","keyType","key_type","getTableValues","tableName","getQuerySelectTop","limit","wrapIdentifier","filterDatabase","item","databaseField","value","only","length","executeQuery","queryText","commands","identifyCommands","type","isMultipleQuery","parseRowQueryResult","_","index","pid","canceling","cancelable","errors","CANCELED_BY_USER","sqlectronError","execute","connectionClient","dataPid","race","wait","discard","cancel","Error","listDatabases","filter","Database","getTableCreateScript","getViewCreateScript","view","getRoutineCreateScript","routine","toUpperCase","replace","getSchema","schema","truncateAllTables","truncateAllQuery","table_name","join","command","isSelect","Array","isArray","rows","rowCount","undefined","affectedRows","config","host","port","user","password","multipleStatements","dateStrings","supportBigNumbers","bigNumberStrings","sshTunnel","localHost","localPort","ssl","rejectUnauthorized"],"mappings":"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","file":"MysqlProviderFactory.js","sourcesContent":["/* eslint-disable */\n// @TODO: Add flow annotation\nimport mysql from 'mysql';\nimport { identify } from 'sql-query-identifier';\nimport BaseProvider from './BaseProvider';\nimport createLogger from '../../Logger';\nimport { createCancelablePromise } from '../../Utils';\nimport errors from '../../Errors';\nimport type {\n  ProviderInterface,\n  FactoryType,\n  serverType,\n  databaseType,\n  queryArgsType\n} from './ProviderInterface';\n\ntype driverExecuteResponse = {\n  data: Array<Object>\n};\n\n/**\n * @TODO: Why are we using this.connection.connection? Seems hard to follow\n *        Refactor to use just this.connection instead\n *\n *        Add typings for the responses of driverExecuteQuery(). Each response\n *        is different\n */\nclass MysqlProvider extends BaseProvider implements ProviderInterface {\n  mysqlErrors = {\n    EMPTY_QUERY: 'ER_EMPTY_QUERY',\n    CONNECTION_LOST: 'PROTOCOL_CONNECTION_LOST'\n  };\n\n  connection: {\n    connection: {\n      pool: {},\n      query: (\n        query: string,\n        args: Array<string>,\n        cb: (\n          err?: Error,\n          data: Array<{\n            column_name: string,\n            data_type: string,\n\n            scheme: string\n          }>,\n          fields: Array<string>\n        ) => void\n      ) => void\n    },\n    pool: {\n      end: () => void,\n      getConnection: (cb: (errPool, connection) => void) => void\n    }\n  };\n\n  constructor(server: serverType, database: databaseType, connection) {\n    super(server, database);\n    this.connection = connection;\n  }\n\n  disconnect() {\n    this.connection.pool.end();\n  }\n\n  async runWithConnection(run) {\n    const { pool } = this.connection;\n    let rejected = false;\n\n    return new Promise((resolve, reject) => {\n      const rejectErr = err => {\n        if (!rejected) {\n          rejected = true;\n          reject(err);\n        }\n      };\n\n      return pool.getConnection(async (errPool, _connection) => {\n        if (errPool) {\n          return rejectErr(errPool);\n        }\n\n        _connection.on('error', error => {\n          // it will be handled later in the next query execution\n          logger().error('Connection fatal error %j', error);\n        });\n\n        try {\n          resolve(await run(_connection));\n        } catch (err) {\n          rejectErr(err);\n        } finally {\n          _connection.release();\n        }\n\n        return _connection;\n      });\n    });\n  }\n\n  getRealError(err: Error) {\n    /* eslint no-underscore-dangle: 0 */\n    return this.connection &&\n      this.connection._protocol &&\n      this.connection._protocol._fatalError\n      ? this.connection._protocol._fatalError\n      : err;\n  }\n\n  driverExecuteQuery(queryArgs: queryArgsType): Promise<driverExecuteResponse> {\n    const runQuery = connection =>\n      new Promise((resolve, reject) => {\n        connection.query(\n          queryArgs.query,\n          queryArgs.params,\n          (err?: Error, data?: Array<{ scheme: string }>, fields) => {\n            if (err && err.code === this.mysqlErrors.EMPTY_QUERY) {\n              return resolve({});\n            }\n            if (err) return reject(this.getRealError(connection, err));\n\n            return resolve({ data, fields });\n          }\n        );\n      });\n\n    return this.connection.connection\n      ? runQuery(this.connection.connection)\n      : this.runWithConnection(runQuery);\n  }\n\n  async listTables() {\n    const sql = `\n      SELECT table_name as name\n      FROM information_schema.tables\n      WHERE table_schema = database()\n      AND table_type NOT LIKE '%VIEW%'\n      ORDER BY table_name\n    `;\n\n    return this.driverExecuteQuery({ query: sql }).then(res => res.data);\n  }\n\n  listViews() {\n    const sql = `\n      SELECT table_name as name\n      FROM information_schema.views\n      WHERE table_schema = database()\n      ORDER BY table_name\n    `;\n\n    return this.driverExecuteQuery({ query: sql }).then(res => res.data);\n  }\n\n  async listRoutines() {\n    const sql = `\n      SELECT routine_name, routine_type\n      FROM information_schema.routines\n      WHERE routine_schema = database()\n      ORDER BY routine_name\n    `;\n\n    type res = {\n      data: Array<{\n        routine_type: string,\n        routine_name: string\n      }>\n    };\n\n    const { data }: res = await this.driverExecuteQuery({ query: sql });\n\n    return data.map(row => ({\n      routineName: row.routine_name,\n      routineType: row.routine_type\n    }));\n  }\n\n  async listTableColumns(table: string) {\n    const sql = `\n      SELECT column_name, data_type\n      FROM information_schema.columns\n      WHERE table_schema = database()\n      AND table_name = ?\n    `;\n    const params = [table];\n\n    type res = {\n      data: Array<{\n        column_name: string,\n        data_type: string\n      }>\n    };\n\n    const { data }: res = await this.driverExecuteQuery({ query: sql, params });\n\n    return data.map(row => ({\n      columnName: row.column_name,\n      dataType: row.data_type\n    }));\n  }\n\n  async listTableTriggers(table: string) {\n    const sql = `\n      SELECT trigger_name\n      FROM information_schema.triggers\n      WHERE event_object_schema = database()\n      AND event_object_table = ?\n    `;\n    const params = [table];\n    const { data } = await this.driverExecuteQuery({ query: sql, params });\n\n    return data.map(row => row.trigger_name);\n  }\n\n  async listTableIndexes(database: string, table: string) {\n    const sql = 'SHOW INDEX FROM ?? FROM ??';\n    const params = [table, database];\n    const { data } = await this.driverExecuteQuery({ query: sql, params });\n\n    return data.map(row => row.Key_name);\n  }\n\n  listSchemas() {\n    return Promise.resolve([]);\n  }\n\n  async getTableReferences(table: string) {\n    const sql = `\n      SELECT referenced_table_name\n      FROM information_schema.key_column_usage\n      WHERE referenced_table_name IS NOT NULL\n      AND table_schema = database()\n      AND table_name = ?\n    `;\n    const params = [table];\n    const { data } = await this.driverExecuteQuery({ query: sql, params });\n\n    return data.map(row => row.referenced_table_name);\n  }\n\n  async getTableColumns(database: string, table: string) {\n    const sql = `\n      SELECT constraint_name, column_name, referenced_table_name,\n        CASE WHEN (referenced_table_name IS NOT NULL) THEN 'FOREIGN'\n        ELSE constraint_name\n        END as key_type\n      FROM information_schema.key_column_usage\n      WHERE table_schema = database()\n      AND table_name = ?\n      AND ((referenced_table_name IS NOT NULL) OR constraint_name LIKE '%PRIMARY%')\n    `;\n    const params = [table];\n    const { data } = await this.driverExecuteQuery({ query: sql, params });\n\n    return data.map(row => ({\n      constraintName: `${row.constraint_name} KEY`,\n      columnName: row.column_name,\n      referencedTable: row.referenced_table_name,\n      keyType: `${row.key_type} KEY`\n    }));\n  }\n\n  async getTableValues(tableName: string) {\n    const sql = `\n      SELECT * FROM ${tableName};\n    `;\n    const { data } = await this.driverExecuteQuery({ query: sql });\n    return data;\n  }\n\n  getQuerySelectTop(table: string, limit: number) {\n    return `SELECT * FROM ${this.wrapIdentifier(table)} LIMIT ${limit}`;\n  }\n\n  filterDatabase(item, { database } = {}, databaseField) {\n    if (!database) {\n      return true;\n    }\n\n    const value = item[databaseField];\n    if (typeof database === 'string') {\n      return database === value;\n    }\n\n    const { only } = database;\n\n    return !(only && only.length);\n  }\n\n  async executeQuery(queryText: string) {\n    const { fields, data } = await this.driverExecuteQuery({\n      query: queryText\n    });\n    if (!data) {\n      return [];\n    }\n\n    const commands = this.identifyCommands(queryText).map(item => item.type);\n\n    if (!this.isMultipleQuery(fields)) {\n      return [this.parseRowQueryResult(data, fields, commands[0])];\n    }\n\n    return data.map((_, index) =>\n      this.parseRowQueryResult(data[index], fields[index], commands[index])\n    );\n  }\n\n  query(queryText: string) {\n    let pid = null;\n    let canceling = false;\n    const cancelable = createCancelablePromise({\n      ...errors.CANCELED_BY_USER,\n      sqlectronError: 'CANCELED_BY_USER'\n    });\n\n    return {\n      execute() {\n        return this.runWithConnection(async connection => {\n          const connectionClient = { connection };\n          const { data: dataPid } = await this.driverExecuteQuery(\n            connectionClient,\n            {\n              query: 'SELECT connection_id() AS pid'\n            }\n          );\n\n          pid = dataPid[0].pid;\n\n          try {\n            const data = await Promise.race([\n              cancelable.wait(),\n              this.executeQuery(connectionClient, queryText)\n            ]);\n\n            pid = null;\n\n            return data;\n          } catch (err) {\n            if (canceling && err.code === this.mysqlErrors.CONNECTION_LOST) {\n              canceling = false;\n              err.sqlectronError = 'CANCELED_BY_USER';\n            }\n\n            throw err;\n          } finally {\n            cancelable.discard();\n          }\n        });\n      },\n\n      async cancel() {\n        if (!pid) {\n          throw new Error('Query not ready to be canceled');\n        }\n\n        canceling = true;\n\n        try {\n          await this.driverExecuteQuery({\n            query: `kill ${pid};`\n          });\n          cancelable.cancel();\n        } catch (err) {\n          canceling = false;\n          throw new Error(err);\n        }\n      }\n    };\n  }\n\n  async listDatabases(filter) {\n    const sql = 'show databases';\n    const { data } = await this.driverExecuteQuery({ query: sql });\n\n    return data\n      .filter(item => this.filterDatabase(item, filter, 'Database'))\n      .map(row => row.Database);\n  }\n\n  async getTableCreateScript(table: string) {\n    const sql = `SHOW CREATE TABLE ${table}`;\n    const { data } = await this.driverExecuteQuery({ query: sql });\n    return data.map(row => row['Create Table']);\n  }\n\n  async getViewCreateScript(view) {\n    const sql = `SHOW CREATE VIEW ${view}`;\n    const { data } = await this.driverExecuteQuery({ query: sql });\n    return data.map(row => row['Create View']);\n  }\n\n  async getRoutineCreateScript(routine, type: string) {\n    const sql = `SHOW CREATE ${type.toUpperCase()} ${routine}`;\n    const { data } = await this.driverExecuteQuery({ query: sql });\n    return data.map(row => row[`Create ${type}`]);\n  }\n\n  wrapIdentifier(value) {\n    return value !== '*' ? `\\`${value.replace(/`/g, '``')}\\`` : '*';\n  }\n\n  async getSchema(): Promise<string> {\n    const sql = \"SELECT database() AS 'schema'\";\n    const { data } = await this.driverExecuteQuery({ query: sql });\n    return data[0].schema;\n  }\n\n  truncateAllTables() {\n    return this.runWithConnection(async () => {\n      const schema = await this.getSchema();\n      const sql = `\n        SELECT table_name\n        FROM information_schema.tables\n        WHERE table_schema = '${schema}'\n        AND table_type NOT LIKE '%VIEW%'\n      `;\n\n      const { data } = await this.driverExecuteQuery({ query: sql });\n\n      const truncateAllQuery = data\n        .map(\n          row => `\n          SET FOREIGN_KEY_CHECKS = 0;\n          TRUNCATE TABLE ${this.wrapIdentifier(schema)}.${this.wrapIdentifier(\n            row.table_name\n          )};\n          SET FOREIGN_KEY_CHECKS = 1;\n        `\n        )\n        .join('');\n\n      return this.driverExecuteQuery({ query: truncateAllQuery });\n    });\n  }\n\n  parseRowQueryResult(data, fields, command) {\n    // Fallback in case the identifier could not reconize the command\n    const isSelect = Array.isArray(data);\n    return {\n      command: command || (isSelect && 'SELECT'),\n      rows: isSelect ? data : [],\n      fields: fields || [],\n      rowCount: isSelect ? (data || []).length : undefined,\n      affectedRows: !isSelect ? data.affectedRows : undefined\n    };\n  }\n\n  isMultipleQuery(fields) {\n    if (!fields) {\n      return false;\n    }\n    if (!fields.length) {\n      return false;\n    }\n    return Array.isArray(fields[0]) || fields[0] === undefined;\n  }\n\n  identifyCommands(queryText) {\n    try {\n      return identify(queryText);\n    } catch (err) {\n      return [];\n    }\n  }\n}\n\nfunction configDatabase(server: serverType, database: databaseType) {\n  const config = {\n    host: server.config.host,\n    port: server.config.port,\n    user: server.config.user,\n    password: server.config.password,\n    database: database.database,\n    multipleStatements: true,\n    dateStrings: true,\n    supportBigNumbers: true,\n    bigNumberStrings: true\n  };\n\n  if (server.sshTunnel) {\n    config.host = server.config.localHost;\n    config.port = server.config.localPort;\n  }\n\n  if (server.config.ssl) {\n    config.ssl = {\n      // It is not the best recommend way to use SSL with node-mysql\n      // https://github.com/felixge/node-mysql#ssl-options\n      // But this way we have compatibility with all clients.\n      rejectUnauthorized: false\n    };\n  }\n\n  return config;\n}\n\nasync function MysqlProviderFactory(\n  server: serverType,\n  database: databaseType\n): FactoryType {\n  const databaseConfig = configDatabase(server, database);\n  const logger = createLogger('db:clients:mysql');\n  logger().debug(\n    'create driver client for mysql with config %j',\n    databaseConfig\n  );\n\n  const connection = {\n    pool: mysql.createPool(databaseConfig)\n  };\n  const provider = new MysqlProvider(server, database, connection);\n\n  // light solution to test connection with with the server\n  await provider.driverExecuteQuery({ query: 'select version();' });\n\n  return provider;\n}\n\nexport default MysqlProviderFactory;\n"]}