{"version":3,"sources":["../../../src/database/provider_clients/MysqlProviderFactory.js"],"names":["server","database","databaseConfig","configDatabase","logger","createLogger","debug","connection","pool","mysql","createPool","provider","MysqlProvider","driverExecuteQuery","query","MysqlProviderFactory","identify","BaseProvider","createCancelablePromise","errors","constructor","mysqlErrors","EMPTY_QUERY","CONNECTION_LOST","disconnect","end","runWithConnection","run","rejected","Promise","resolve","reject","rejectErr","err","getConnection","errPool","_connection","on","error","release","getRealError","_protocol","_fatalError","queryArgs","runQuery","params","data","fields","code","getTables","sql","then","res","getViews","getRoutines","map","routineName","row","routine_name","routineType","routine_type","getTableColumns","table","columnName","column_name","dataType","data_type","getTableTriggers","trigger_name","getTableIndexes","Key_name","getSchemas","getTableReferences","referenced_table_name","constraintName","constraint_name","referencedTable","keyType","key_type","getTableValues","tableName","getQuerySelectTop","limit","wrapIdentifier","filterDatabase","item","databaseField","value","only","length","executeQuery","queryText","commands","identifyCommands","type","isMultipleQuery","parseRowQueryResult","_","index","pid","canceling","cancelable","CANCELED_BY_USER","sqlectronError","execute","connectionClient","dataPid","race","wait","discard","cancel","Error","getDatabases","filter","Database","getTableCreateScript","getViewCreateScript","view","getRoutineCreateScript","routine","toUpperCase","replace","getSchema","schema","truncateAllTables","truncateAllQuery","table_name","join","command","isSelect","Array","isArray","rows","rowCount","undefined","affectedRows","config","host","port","user","password","multipleStatements","dateStrings","supportBigNumbers","bigNumberStrings","sshTunnel","localHost","localPort","ssl","rejectUnauthorized"],"mappings":"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","file":"MysqlProviderFactory.js","sourcesContent":["/* eslint-disable */\n// @TODO: Add flow annotation\nimport mysql from 'mysql';\nimport { identify } from 'sql-query-identifier';\nimport BaseProvider from './BaseProvider';\nimport createLogger from '../../Logger';\nimport { createCancelablePromise } from '../../Utils';\nimport errors from '../../Errors';\nimport type {\n  ProviderInterface,\n  FactoryType,\n  serverType,\n  databaseType,\n  queryArgsType\n} from './ProviderInterface';\n\ntype driverExecuteResponse = {\n  data: Array<Object>\n};\n\n/**\n * @TODO: Why are we using this.connection.connection? Seems hard to follow\n *        Refactor to use just this.connection instead\n *\n *        Add typings for the responses of driverExecuteQuery(). Each response\n *        is different\n */\nclass MysqlProvider extends BaseProvider implements ProviderInterface {\n  mysqlErrors = {\n    EMPTY_QUERY: 'ER_EMPTY_QUERY',\n    CONNECTION_LOST: 'PROTOCOL_CONNECTION_LOST'\n  };\n\n  connection: {\n    connection: {\n      pool: {},\n      query: (\n        query: string,\n        args: Array<string>,\n        cb: (\n          err?: Error,\n          data: Array<{\n            column_name: string,\n            data_type: string,\n\n            scheme: string\n          }>,\n          fields: Array<string>\n        ) => void\n      ) => void\n    },\n    pool: {\n      end: () => void,\n      getConnection: (cb: (errPool, connection) => void) => void\n    }\n  };\n\n  constructor(server: serverType, database: databaseType, connection) {\n    super(server, database);\n    this.connection = connection;\n  }\n\n  disconnect() {\n    this.connection.pool.end();\n  }\n\n  async runWithConnection(run) {\n    const { pool } = this.connection;\n    let rejected = false;\n\n    return new Promise((resolve, reject) => {\n      const rejectErr = err => {\n        if (!rejected) {\n          rejected = true;\n          reject(err);\n        }\n      };\n\n      return pool.getConnection(async (errPool, _connection) => {\n        if (errPool) {\n          return rejectErr(errPool);\n        }\n\n        _connection.on('error', error => {\n          // it will be handled later in the next query execution\n          logger().error('Connection fatal error %j', error);\n        });\n\n        try {\n          resolve(await run(_connection));\n        } catch (err) {\n          rejectErr(err);\n        } finally {\n          _connection.release();\n        }\n\n        return _connection;\n      });\n    });\n  }\n\n  getRealError(err: Error) {\n    /* eslint no-underscore-dangle: 0 */\n    return this.connection &&\n      this.connection._protocol &&\n      this.connection._protocol._fatalError\n      ? this.connection._protocol._fatalError\n      : err;\n  }\n\n  driverExecuteQuery(queryArgs: queryArgsType): Promise<driverExecuteResponse> {\n    const runQuery = connection =>\n      new Promise((resolve, reject) => {\n        connection.query(\n          queryArgs.query,\n          queryArgs.params,\n          (err?: Error, data?: Array<{ scheme: string }>, fields) => {\n            if (err && err.code === this.mysqlErrors.EMPTY_QUERY) {\n              return resolve({});\n            }\n            if (err) return reject(this.getRealError(connection, err));\n\n            return resolve({ data, fields });\n          }\n        );\n      });\n\n    return this.connection.connection\n      ? runQuery(this.connection.connection)\n      : this.runWithConnection(runQuery);\n  }\n\n  async getTables() {\n    const sql = `\n      SELECT table_name as name\n      FROM information_schema.tables\n      WHERE table_schema = database()\n      AND table_type NOT LIKE '%VIEW%'\n      ORDER BY table_name\n    `;\n\n    return this.driverExecuteQuery({ query: sql }).then(res => res.data);\n  }\n\n  getViews() {\n    const sql = `\n      SELECT table_name as name\n      FROM information_schema.views\n      WHERE table_schema = database()\n      ORDER BY table_name\n    `;\n\n    return this.driverExecuteQuery({ query: sql }).then(res => res.data);\n  }\n\n  async getRoutines() {\n    const sql = `\n      SELECT routine_name, routine_type\n      FROM information_schema.routines\n      WHERE routine_schema = database()\n      ORDER BY routine_name\n    `;\n\n    type res = {\n      data: Array<{\n        routine_type: string,\n        routine_name: string\n      }>\n    };\n\n    const { data }: res = await this.driverExecuteQuery({ query: sql });\n\n    return data.map(row => ({\n      routineName: row.routine_name,\n      routineType: row.routine_type\n    }));\n  }\n\n  async getTableColumns(table: string) {\n    const sql = `\n      SELECT column_name, data_type\n      FROM information_schema.columns\n      WHERE table_schema = database()\n      AND table_name = ?\n    `;\n    const params = [table];\n\n    type res = {\n      data: Array<{\n        column_name: string,\n        data_type: string\n      }>\n    };\n\n    const { data }: res = await this.driverExecuteQuery({ query: sql, params });\n\n    return data.map(row => ({\n      columnName: row.column_name,\n      dataType: row.data_type\n    }));\n  }\n\n  async getTableTriggers(table: string) {\n    const sql = `\n      SELECT trigger_name\n      FROM information_schema.triggers\n      WHERE event_object_schema = database()\n      AND event_object_table = ?\n    `;\n    const params = [table];\n    const { data } = await this.driverExecuteQuery({ query: sql, params });\n\n    return data.map(row => row.trigger_name);\n  }\n\n  async getTableIndexes(database: string, table: string) {\n    const sql = 'SHOW INDEX FROM ?? FROM ??';\n    const params = [table, database];\n    const { data } = await this.driverExecuteQuery({ query: sql, params });\n\n    return data.map(row => row.Key_name);\n  }\n\n  getSchemas() {\n    return Promise.resolve([]);\n  }\n\n  async getTableReferences(table: string) {\n    const sql = `\n      SELECT referenced_table_name\n      FROM information_schema.key_column_usage\n      WHERE referenced_table_name IS NOT NULL\n      AND table_schema = database()\n      AND table_name = ?\n    `;\n    const params = [table];\n    const { data } = await this.driverExecuteQuery({ query: sql, params });\n\n    return data.map(row => row.referenced_table_name);\n  }\n\n  async getTableColumns(database: string, table: string) {\n    const sql = `\n      SELECT constraint_name, column_name, referenced_table_name,\n        CASE WHEN (referenced_table_name IS NOT NULL) THEN 'FOREIGN'\n        ELSE constraint_name\n        END as key_type\n      FROM information_schema.key_column_usage\n      WHERE table_schema = database()\n      AND table_name = ?\n      AND ((referenced_table_name IS NOT NULL) OR constraint_name LIKE '%PRIMARY%')\n    `;\n    const params = [table];\n    const { data } = await this.driverExecuteQuery({ query: sql, params });\n\n    return data.map(row => ({\n      constraintName: `${row.constraint_name} KEY`,\n      columnName: row.column_name,\n      referencedTable: row.referenced_table_name,\n      keyType: `${row.key_type} KEY`\n    }));\n  }\n\n  async getTableValues(tableName: string) {\n    const sql = `\n      SELECT * FROM ${tableName};\n    `;\n    const { data } = await this.driverExecuteQuery({ query: sql });\n    return data;\n  }\n\n  getQuerySelectTop(table: string, limit: number) {\n    return `SELECT * FROM ${this.wrapIdentifier(table)} LIMIT ${limit}`;\n  }\n\n  filterDatabase(item, { database } = {}, databaseField) {\n    if (!database) {\n      return true;\n    }\n\n    const value = item[databaseField];\n    if (typeof database === 'string') {\n      return database === value;\n    }\n\n    const { only } = database;\n\n    return !(only && only.length);\n  }\n\n  async executeQuery(queryText: string) {\n    const { fields, data } = await this.driverExecuteQuery({\n      query: queryText\n    });\n    if (!data) {\n      return [];\n    }\n\n    const commands = this.identifyCommands(queryText).map(item => item.type);\n\n    if (!this.isMultipleQuery(fields)) {\n      return [this.parseRowQueryResult(data, fields, commands[0])];\n    }\n\n    return data.map((_, index) =>\n      this.parseRowQueryResult(data[index], fields[index], commands[index])\n    );\n  }\n\n  query(queryText: string) {\n    let pid = null;\n    let canceling = false;\n    const cancelable = createCancelablePromise({\n      ...errors.CANCELED_BY_USER,\n      sqlectronError: 'CANCELED_BY_USER'\n    });\n\n    return {\n      execute() {\n        return this.runWithConnection(async connection => {\n          const connectionClient = { connection };\n          const { data: dataPid } = await this.driverExecuteQuery(\n            connectionClient,\n            {\n              query: 'SELECT connection_id() AS pid'\n            }\n          );\n\n          pid = dataPid[0].pid;\n\n          try {\n            const data = await Promise.race([\n              cancelable.wait(),\n              this.executeQuery(connectionClient, queryText)\n            ]);\n\n            pid = null;\n\n            return data;\n          } catch (err) {\n            if (canceling && err.code === this.mysqlErrors.CONNECTION_LOST) {\n              canceling = false;\n              err.sqlectronError = 'CANCELED_BY_USER';\n            }\n\n            throw err;\n          } finally {\n            cancelable.discard();\n          }\n        });\n      },\n\n      async cancel() {\n        if (!pid) {\n          throw new Error('Query not ready to be canceled');\n        }\n\n        canceling = true;\n\n        try {\n          await this.driverExecuteQuery({\n            query: `kill ${pid};`\n          });\n          cancelable.cancel();\n        } catch (err) {\n          canceling = false;\n          throw new Error(err);\n        }\n      }\n    };\n  }\n\n  async getDatabases(filter) {\n    const sql = 'show databases';\n    const { data } = await this.driverExecuteQuery({ query: sql });\n\n    return data\n      .filter(item => this.filterDatabase(item, filter, 'Database'))\n      .map(row => row.Database);\n  }\n\n  async getTableCreateScript(table: string) {\n    const sql = `SHOW CREATE TABLE ${table}`;\n    const { data } = await this.driverExecuteQuery({ query: sql });\n    return data.map(row => row['Create Table']);\n  }\n\n  async getViewCreateScript(view) {\n    const sql = `SHOW CREATE VIEW ${view}`;\n    const { data } = await this.driverExecuteQuery({ query: sql });\n    return data.map(row => row['Create View']);\n  }\n\n  async getRoutineCreateScript(routine, type: string) {\n    const sql = `SHOW CREATE ${type.toUpperCase()} ${routine}`;\n    const { data } = await this.driverExecuteQuery({ query: sql });\n    return data.map(row => row[`Create ${type}`]);\n  }\n\n  wrapIdentifier(value) {\n    return value !== '*' ? `\\`${value.replace(/`/g, '``')}\\`` : '*';\n  }\n\n  async getSchema(): Promise<string> {\n    const sql = \"SELECT database() AS 'schema'\";\n    const { data } = await this.driverExecuteQuery({ query: sql });\n    return data[0].schema;\n  }\n\n  truncateAllTables() {\n    return this.runWithConnection(async () => {\n      const schema = await this.getSchema();\n      const sql = `\n        SELECT table_name\n        FROM information_schema.tables\n        WHERE table_schema = '${schema}'\n        AND table_type NOT LIKE '%VIEW%'\n      `;\n\n      const { data } = await this.driverExecuteQuery({ query: sql });\n\n      const truncateAllQuery = data\n        .map(\n          row => `\n          SET FOREIGN_KEY_CHECKS = 0;\n          TRUNCATE TABLE ${this.wrapIdentifier(schema)}.${this.wrapIdentifier(\n            row.table_name\n          )};\n          SET FOREIGN_KEY_CHECKS = 1;\n        `\n        )\n        .join('');\n\n      return this.driverExecuteQuery({ query: truncateAllQuery });\n    });\n  }\n\n  parseRowQueryResult(data, fields, command) {\n    // Fallback in case the identifier could not reconize the command\n    const isSelect = Array.isArray(data);\n    return {\n      command: command || (isSelect && 'SELECT'),\n      rows: isSelect ? data : [],\n      fields: fields || [],\n      rowCount: isSelect ? (data || []).length : undefined,\n      affectedRows: !isSelect ? data.affectedRows : undefined\n    };\n  }\n\n  isMultipleQuery(fields) {\n    if (!fields) {\n      return false;\n    }\n    if (!fields.length) {\n      return false;\n    }\n    return Array.isArray(fields[0]) || fields[0] === undefined;\n  }\n\n  identifyCommands(queryText) {\n    try {\n      return identify(queryText);\n    } catch (err) {\n      return [];\n    }\n  }\n}\n\nfunction configDatabase(server: serverType, database: databaseType) {\n  const config = {\n    host: server.config.host,\n    port: server.config.port,\n    user: server.config.user,\n    password: server.config.password,\n    database: database.database,\n    multipleStatements: true,\n    dateStrings: true,\n    supportBigNumbers: true,\n    bigNumberStrings: true\n  };\n\n  if (server.sshTunnel) {\n    config.host = server.config.localHost;\n    config.port = server.config.localPort;\n  }\n\n  if (server.config.ssl) {\n    config.ssl = {\n      // It is not the best recommend way to use SSL with node-mysql\n      // https://github.com/felixge/node-mysql#ssl-options\n      // But this way we have compatibility with all clients.\n      rejectUnauthorized: false\n    };\n  }\n\n  return config;\n}\n\nasync function MysqlProviderFactory(\n  server: serverType,\n  database: databaseType\n): FactoryType {\n  const databaseConfig = configDatabase(server, database);\n  const logger = createLogger('db:clients:mysql');\n  logger().debug(\n    'create driver client for mysql with config %j',\n    databaseConfig\n  );\n\n  const connection = {\n    pool: mysql.createPool(databaseConfig)\n  };\n  const provider = new MysqlProvider(server, database, connection);\n\n  // light solution to test connection with with the server\n  await provider.driverExecuteQuery({ query: 'select version();' });\n\n  return provider;\n}\n\nexport default MysqlProviderFactory;\n"]}