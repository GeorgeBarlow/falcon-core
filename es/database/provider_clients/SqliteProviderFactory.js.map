{"version":3,"sources":["../../../src/database/provider_clients/SqliteProviderFactory.js"],"names":["server","database","logger","createLogger","dbConfig","configDatabase","connection","debug","provider","SqliteProvider","driverExecuteQuery","query","SqliteFactory","sqlite3","getPort","cors","identify","BaseProvider","constructor","privateGraphQLServerIsRunning","disconnect","wrapIdentifier","value","matched","match","replace","getQuerySelectTop","table","limit","Promise","resolve","getLogs","logs","map","log","setLogs","queryText","queryConnection","self","execute","runWithConnection","executeQuery","err","code","CANCELED","sqlectronError","cancel","Error","interrupt","result","multiple","parseRowQueryResult","getConnectionType","insert","rows","tableColumns","getTableColumnNames","rowSqls","rowData","row","key","join","then","res","data","update","records","tablePrimaryKey","getTableKey","queries","columnNames","Object","keys","record","changes","edits","columnName","name","rowPrimaryKeyValue","finalQuery","delete","primaryKey","conditions","results","getVersion","getTableColumns","raw","sql","rawResults","columns","primaryKeyColumn","find","pk","undefined","getTableRows","sqlIds","sqlData","rowid","all","i","metadata","id","tableKey","getTableNames","renameTable","oldTableName","newTableName","dropTable","addTableColumn","columnType","renameTableColumns","originalColumns","forEach","includes","column","oldColumnName","propertiesArr","getTablePropertiesSql","newColumnName","dropTableColumns","columnsToDrop","temp","e","permittedColumns","filter","col","filteredPropertiesArr","substring","indexOf","lastIndexOf","getCreateTableSql","createTableArgs","creationScript","trim","betweenParaentheses","split","listTables","listViews","listRoutines","checkIsConnected","listTableColumns","dataType","type","listTableTriggers","listTableIndexes","listSchemas","listDatabases","file","getTableReferences","getTableCreateScript","getViewCreateScript","view","getRoutineCreateScript","isOnline","truncateTable","truncateSingleQuery","truncateAllTables","tables","truncateAllQuery","statement","isSelect","Array","isArray","command","fields","rowCount","length","affectedRows","identifyCommands","strict","queryArgs","runQuery","executionType","text","reject","method","resolveExecutionType","queryCallback","lastID","run","params","identifyStatementsRunQuery","statements","verbose","db","Database","on","duration","push","failed","fn","serialize","runErr","close","checkUnsupported","exportOptions","unsupportedOptions","hasUnsupported","some","option","JSON","stringify","getGraphQLServerPort","graphQLServerPort","startGraphQLServer","graphQLServerIsRunning","graphqlHTTP","tuql","express","x","default","buildSchemaFromDatabase","app","schema","port","use","graphQLServer","listen","console","stopGraphQLServer"],"mappings":"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","file":"SqliteProviderFactory.js","sourcesContent":["// @flow\nimport sqlite3 from 'sqlite3';\nimport getPort from 'get-port';\nimport cors from 'cors';\nimport { identify } from 'sql-query-identifier';\nimport type { Application } from 'express';\nimport createLogger from '../../Logger';\nimport BaseProvider from './BaseProvider';\nimport type {\n  ProviderInterface,\n  FactoryType,\n  serverType,\n  exportOptionsType,\n  queryType,\n  queryResponseType,\n  databaseType,\n  logType\n} from './ProviderInterface';\n\ntype queryArgsType = {\n  query: string,\n  multiple?: boolean,\n  params?: Array<string>\n};\n\ntype connectionType = {\n  dbConfig: {\n    database: string\n  },\n  run: (queryText: string, args?: Array<string>, cb?: () => void) => void,\n  all: (queryText: string, args?: Array<string>, cb?: () => void) => void\n};\n\n/**\n * Contains data about a column/property/key in a table\n */\ntype tableKeyType = {\n  cid: number,\n  name: string,\n  type: string,\n  notnull: 0 | 1,\n  dflt_value: string,\n  pk: 0 | 1 | 2\n};\n\ntype RowMetadata = {\n  id: string | number,\n  tableKey: string\n};\n\n// @TODO: Why does logging in constructor vs logging in driver execute\n// return two different things\nclass SqliteProvider extends BaseProvider implements ProviderInterface {\n  connection: connectionType;\n\n  graphQLServer: Application;\n\n  graphQLServerPort: ?number;\n\n  /**\n   * @private\n   */\n  privateGraphQLServerIsRunning: boolean = false;\n\n  constructor(server: Object, database: Object, connection: Object) {\n    super(server, database);\n    this.connection = connection;\n  }\n\n  // @NOT_SUPPORTED\n  disconnect() {\n    // SQLite does not have connection poll. So we open and close connections\n    // for every query request. This allows multiple request at same time by\n    // using a different thread for each connection.\n    // This may cause connection limit problem. So we may have to change this at some point.\n  }\n\n  wrapIdentifier(value: string): string {\n    if (value === '*') {\n      return value;\n    }\n\n    const matched = value.match(/(.*?)(\\[[0-9]\\])/); // eslint-disable-line no-useless-escape\n\n    return matched\n      ? this.wrapIdentifier(matched[1]) + matched[2]\n      : `\"${value.replace(/\"/g, '\"\"')}\"`;\n  }\n\n  getQuerySelectTop(table: string, limit: number) {\n    return Promise.resolve(\n      `SELECT * FROM ${this.wrapIdentifier(table)} LIMIT ${limit}`\n    );\n  }\n\n  async getLogs(): Promise<Array<logType>> {\n    return this.logs.map(log => ({\n      ...log,\n      query: log.query.replace(/(\\r\\n|\\n|\\r)/gm, '')\n    }));\n  }\n\n  /**\n   * @TODO\n   */\n  async setLogs() {\n    return Promise.resolve();\n  }\n\n  query(queryText: string): Promise<queryType> {\n    let queryConnection = null;\n    const self = this;\n\n    return Promise.resolve({\n      execute() {\n        return self.runWithConnection(() => {\n          try {\n            queryConnection = self.connection;\n            return self.executeQuery(queryText);\n          } catch (err) {\n            if (err.code === self.CANCELED) {\n              err.sqlectronError = 'CANCELED_BY_USER';\n            }\n            throw err;\n          }\n        });\n      },\n      cancel() {\n        if (!queryConnection) {\n          throw new Error('Query not ready to be canceled');\n        }\n        queryConnection.interrupt();\n      }\n    });\n  }\n\n  async executeQuery(queryText: string) {\n    const result = await this.driverExecuteQuery({\n      query: queryText,\n      multiple: true\n    });\n    return result.map(this.parseRowQueryResult);\n  }\n\n  getConnectionType() {\n    return Promise.resolve('local');\n  }\n\n  /**\n   * Inserts a record into a table. If values is an empty object, will insert\n   * an empty row\n   */\n  async insert(\n    table: string,\n    rows: Array<{ [string]: any }>\n  ): Promise<{ timing: number }> {\n    const tableColumns = await this.getTableColumnNames(table);\n    const rowSqls = rows.map(row => {\n      const rowData = tableColumns.map(\n        key => (row[key] ? `'${row[key]}'` : 'NULL')\n      );\n      return `(${rowData.join(', ')})`;\n    });\n    const query = `\n     INSERT INTO ${table} (${tableColumns.join(', ')})\n     VALUES\n     ${rowSqls.join(',\\n')};\n    `;\n    return this.driverExecuteQuery({ query }).then(res => res.data);\n  }\n\n  /**\n   * Each item in records will update new values in changes\n   * @param changes - Object contaning column:newValue pairs\n   * @param rowPrimaryKey - The row's (record's) identifier\n   */\n  async update(\n    table: string,\n    records: Array<{\n      rowPrimaryKey: { [string]: any },\n      changes: { [string]: any }\n    }>\n  ): Promise<{ timing: number }> {\n    const tablePrimaryKey = await this.getTableKey(table);\n    const queries = records.map(record => {\n      const columnNames = Object.keys(record.changes);\n      const edits = columnNames.map(\n        columnName => `${columnName} = '${record.changes[columnName]}'`\n      );\n      return `\n        UPDATE ${table}\n        SET ${edits.join(', ')}\n        WHERE ${tablePrimaryKey.name} = ${record.rowPrimaryKeyValue};\n    `;\n    });\n    const finalQuery = queries.join('\\n');\n    return this.driverExecuteQuery({ query: finalQuery }).then(res => res.data);\n  }\n\n  /**\n   * Deletes records from a table. Finds table's primary key then deletes\n   * specified columns\n   */\n  async delete(\n    table: string,\n    keys: Array<string | number>\n  ): Promise<{ timing: number }> {\n    const primaryKey = await this.getTableKey(table);\n    const conditions = keys.map(key => `${primaryKey.name} = \"${key}\"`);\n    const query = `\n      DELETE FROM ${table}\n      WHERE ${conditions.join(' OR ')}\n    `;\n    const results = await this.driverExecuteQuery({ query }).then(\n      res => res.data\n    );\n    return results;\n  }\n\n  getVersion(): Promise<number | string> {\n    return this.driverExecuteQuery({ query: 'SELECT sqlite_version()' }).then(\n      res => res.data[0]['sqlite_version()']\n    );\n  }\n\n  /**\n   * Gets data about columns (properties) in a table\n   */\n  async getTableColumns(\n    table: string,\n    raw: boolean = false\n  ): Promise<Array<tableKeyType>> {\n    const sql = `PRAGMA table_info(${table})`;\n    const rawResults = this.driverExecuteQuery({ query: sql }).then(\n      res => res.data\n    );\n    return raw ? rawResults : rawResults.then(res => res);\n  }\n\n  async getTableKey(table: string): Promise<tableKeyType> {\n    const columns = await this.getTableColumns(table);\n    const primaryKeyColumn = columns.find(key => key.pk === 1);\n    return primaryKeyColumn === undefined ? 'rowid' : primaryKeyColumn;\n  }\n\n  /**\n   * Returns the rows of a table along with its metadata\n   * @TODO: Method does not handle WITHOUT ROWID tables\n   * @TODO: If rowid is a hidden field, should hide it in the results\n   */\n  async getTableRows(\n    table: string\n  ): [{ rows: { [string]: any }, metadata: RowMetadata }] {\n    // sqlite statement for actual row data\n    const key = await this.getTableKey(table);\n    const sqlIds = `\n      SELECT ${key.name}\n      FROM '${table}';\n    `;\n    const sqlData = `\n      SELECT *\n      FROM '${table}';\n    `;\n\n    const [rows, rowid] = await Promise.all([\n      this.driverExecuteQuery({ query: sqlData }),\n      // @HACK: HARDCODE. SQLITE ONLY\n      this.driverExecuteQuery({ query: sqlIds })\n    ]);\n    return rows.data.map((row, i) => ({\n      row,\n      metadata: {\n        id: rowid.data[i][key.name],\n        tableKey: key.name\n      }\n    }));\n  }\n\n  async getTableNames() {\n    const sql = `\n      SELECT name\n      FROM sqlite_master\n      WHERE type='table'\n    `;\n    return this.driverExecuteQuery({ query: sql }).then(res =>\n      res.data.map(table => table.name)\n    );\n  }\n\n  /**\n   * Renames a table in the database\n   */\n  async renameTable(oldTableName: string, newTableName: string) {\n    const sql = `\n      ALTER TABLE ${oldTableName}\n        RENAME TO ${newTableName};\n    `;\n    return this.driverExecuteQuery({ query: sql }).then(res => res.data);\n  }\n\n  /**\n   * Drops a table from the database\n   */\n  async dropTable(table: string) {\n    const sql = `\n      DROP TABLE ${table};\n    `;\n    return this.driverExecuteQuery({ query: sql }).then(res => res.data);\n  }\n\n  /**\n   * Adds a column to the table\n   */\n  async addTableColumn(table: string, columnName: string, columnType: string) {\n    const sql = `\n    ALTER TABLE ${table}\n      ADD COLUMN \"${columnName}\" ${columnType};\n    `;\n    return this.driverExecuteQuery({ query: sql }).then(res => res.data);\n  }\n\n  // TODO: This needs to be wrapped in a transaction\n  async renameTableColumns(\n    table: string,\n    columns: Array<{ oldColumnName: string, newColumnName: string }>\n  ) {\n    // Used to make verify that each columns actually exist within the table\n    const originalColumns = await this.getTableColumnNames(table);\n    columns.forEach(column => {\n      if (!originalColumns.includes(column.oldColumnName)) {\n        throw new Error(`${column.oldColumnName} is not a column in ${table}`);\n      }\n    });\n\n    const propertiesArr = await this.getTablePropertiesSql(table);\n    let sql = `\n    PRAGMA foreign_keys=off;\n    BEGIN TRANSACTION;\n    ALTER TABLE ${table} RENAME TO ${table}_temp;\n\n\n    CREATE TABLE ${table} (${propertiesArr.join()}\n    );\n\n    INSERT INTO ${table} (${originalColumns.join(', ')})\n      SELECT ${originalColumns.join(', ')}\n      FROM ${table}_temp;\n\n    DROP TABLE ${table}_temp;\n\n    COMMIT;\n    PRAGMA foreign_keys=on;`;\n\n    // @TODO: Can probably make this more efficient\n    columns.forEach(column => {\n      sql = sql.replace(column.oldColumnName, column.newColumnName);\n    });\n\n    return this.driverExecuteQuery({ query: sql }).then(res => res.data);\n  }\n\n  /**\n   * Drops columns from a table. Does this by creating a new table then\n   * importing the data from the original and ignorng columnsToDrop\n   * @param {*} table the table to drop columns from\n   * @param {*} columnsToDrop array of columns which client wants to drop\n   */\n  async dropTableColumns(table: string, columnsToDrop: Array<string>) {\n    const temp = await this.getTableColumnNames(table);\n\n    columnsToDrop.forEach(e => {\n      if (!temp.includes(e)) {\n        throw new Error(`${e} is not a column in ${table}`);\n      }\n    });\n\n    const permittedColumns = temp.filter(col => !columnsToDrop.includes(col));\n    // Create an sql statement that creates a new table excluding dropped columns\n    const propertiesArr = await this.getTablePropertiesSql(table);\n    const filteredPropertiesArr = propertiesArr.filter(\n      row =>\n        !columnsToDrop.includes(\n          row.substring(row.indexOf('\"') + 1, row.lastIndexOf('\"'))\n        )\n    );\n    const sql = `\n    PRAGMA foreign_keys=off;\n    BEGIN TRANSACTION;\n    ALTER TABLE ${table} RENAME TO ${table}_temp;\n\n\n    CREATE TABLE ${table} (${filteredPropertiesArr.join()}\n    );\n\n    INSERT INTO ${table} (${permittedColumns.join(', ')})\n      SELECT ${permittedColumns.join(', ')}\n      FROM ${table}_temp;\n\n    DROP TABLE ${table}_temp;\n\n    COMMIT;\n    PRAGMA foreign_keys=on;`;\n    return this.driverExecuteQuery({ query: sql }).then(res => res.data);\n  }\n\n  /**\n   * Returns the sql statement to generate this table. Returns it in a uniform\n   * format\n   * Format - after \"(\", each column creation and foreign key constraint\n   * will be in its own line\n   */\n  async getCreateTableSql(table: string): Promise<string> {\n    const createTableArgs = await this.getTablePropertiesSql(table);\n    return `CREATE TABLE ${table} (${createTableArgs.join()})`;\n  }\n\n  /**\n   * Used to get the arguments within a CREATE TABLE table(...)\n   * in a format such that getCreateTableSql() and dropTable() can\n   */\n  async getTablePropertiesSql(table: string): Promise<Array<String>> {\n    const sql = `\n      SELECT sql\n      FROM sqlite_master\n      WHERE name='${table}';\n    `;\n    const creationScript = await this.driverExecuteQuery({\n      query: sql\n    }).then(res => res.data[0].sql.trim());\n\n    // Gets all the text between '(' and ')' of script\n    const betweenParaentheses = creationScript\n      .substring(creationScript.indexOf('(') + 1)\n      .replace(/\\)$/, '')\n      .split(',');\n\n    // Formats each argument to start on a new line with no extra white space\n    // and wraps the column name in an \"<identifier>\" format. Does not\n    // wrap constraints\n    return betweenParaentheses.map(\n      row =>\n        `\\n\\t${\n          row.includes('PRIMARY') || row.includes('FOREIGN')\n            ? row\n                .trim()\n                .replace(/\\r|\\n|/g, '')\n                .replace(/\\s{2,}/g, ' ')\n            : row\n                .trim()\n                .replace(/\\r|\\n|/g, '')\n                .replace(/\\s{2,}/g, ' ')\n                .replace(/\\[|\\]|\"|'/g, '')\n                .replace(/\\[\\w+\\]|\"\\w+\"|'\\w+'|\\w+/, '\"$&\"')\n        }`\n    );\n  }\n\n  async listTables() {\n    const sql = `\n      SELECT name\n      FROM sqlite_master\n      WHERE type='table'\n      ORDER BY name\n    `;\n    return this.driverExecuteQuery({ query: sql }).then(res => res.data);\n  }\n\n  async listViews() {\n    const sql = `\n      SELECT name\n      FROM sqlite_master\n      WHERE type = 'view'\n    `;\n    return this.driverExecuteQuery({ query: sql }).then(res => res.data);\n  }\n\n  // @NOT_SUPPORTED\n  listRoutines() {\n    return Promise.resolve([]);\n  }\n\n  async getTableColumnNames(table: string) {\n    this.checkIsConnected();\n    const columns = await this.listTableColumns(table);\n    return columns.map(column => column.columnName);\n  }\n\n  // @TODO: Find out how this is different from getTableColumns(table)\n  async listTableColumns(table: string) {\n    const sql = `PRAGMA table_info(${table})`;\n    const { data } = await this.driverExecuteQuery({ query: sql });\n\n    return data.map(row => ({\n      columnName: row.name,\n      dataType: row.type\n    }));\n  }\n\n  async listTableTriggers(table: string) {\n    const sql = `\n      SELECT name\n      FROM sqlite_master\n      WHERE type = 'trigger'\n        AND tbl_name = '${table}'\n    `;\n    const { data } = await this.driverExecuteQuery({ query: sql });\n\n    return data.map(row => row.name);\n  }\n\n  async listTableIndexes(table: string) {\n    const sql = `PRAGMA INDEX_LIST('${table}')`;\n    const { data } = await this.driverExecuteQuery({ query: sql });\n\n    return data.map(row => row.name);\n  }\n\n  // @NOT_SUPPORTED\n  listSchemas() {\n    return Promise.resolve([]);\n  }\n\n  async listDatabases() {\n    const result = await this.driverExecuteQuery({\n      query: 'PRAGMA database_list;'\n    });\n\n    if (!result) {\n      throw new Error('No results');\n    }\n\n    return result.data.map(row => row.file || ':memory:');\n  }\n\n  // @TODO\n  getTableReferences() {\n    return Promise.resolve([]);\n  }\n\n  async getTableCreateScript(table: string) {\n    const sql = `\n      SELECT sql\n      FROM sqlite_master\n      WHERE name = '${table}';\n    `;\n    const { data } = await this.driverExecuteQuery({ query: sql });\n\n    return data.map(row => row.sql);\n  }\n\n  async getViewCreateScript(view) {\n    const sql = `\n      SELECT sql\n      FROM sqlite_master\n      WHERE name = '${view}';\n    `;\n    const { data } = await this.driverExecuteQuery({ query: sql });\n\n    return data.map(row => row.sql);\n  }\n\n  // @NOT_SUPPORTED\n  async getRoutineCreateScript() {\n    return '';\n  }\n\n  /**\n   * SQLITE is a local file in there's no concept of being 'online'. Or\n   * are we online when we can verify that the path to the sqlite database\n   * exists?\n   */\n  isOnline() {\n    return Promise.resolve(true);\n  }\n\n  truncateTable(table: string): Promise<void> {\n    return this.runWithConnection(async () => {\n      const truncateSingleQuery = `DELETE FROM ${table}`;\n\n      // @TODO: Check if sqlite_sequence exists then execute:\n      //        DELETE FROM sqlite_sequence WHERE name='${table}';\n      const result = await this.driverExecuteQuery({\n        query: truncateSingleQuery\n      });\n      return result;\n    });\n  }\n\n  truncateAllTables(): Promise<void> {\n    return this.runWithConnection(async () => {\n      const tables: Array<{ name: string }> = await this.listTables();\n\n      const truncateAllQuery = tables\n        .map(\n          table => `\n          DELETE FROM ${table.name};\n        `\n        )\n        .join('');\n\n      // @TODO: Check if sqlite_sequence exists then execute:\n      //        DELETE FROM sqlite_sequence WHERE name='${table}';\n      const result = await this.driverExecuteQuery({ query: truncateAllQuery });\n      return result;\n    });\n  }\n\n  parseRowQueryResult({ data, statement, changes }): queryResponseType {\n    // Fallback in case the identifier could not reconize the command\n    const isSelect = Array.isArray(data);\n    const rows = data || [];\n\n    return {\n      rows,\n      command: statement.type || (isSelect && 'SELECT'),\n      fields: Object.keys(rows[0] || {}).map(name => ({ name })),\n      rowCount: rows.length,\n      affectedRows: changes || 0\n    };\n  }\n\n  identifyCommands(queryText) {\n    try {\n      return identify(queryText, { strict: false });\n    } catch (err) {\n      return [];\n    }\n  }\n\n  /**\n   * 1. Various methods use driverExecutQuery to execute sql statements.\n   * 2. driverExecuteQuery creates identifyStatementsRunQuery() which uses\n   * the also created runQuery()\n   * 3. driverExecuteQuery calls runWithConnection(identifyStatementsRunQuery)\n   * 4. runWithConnection creates a node-sqlite3 db object which uses identifyStatementsRunQuery\n   * to executes the sql statement and runQuery is given to node-sqlite3 to\n   * return the results of the query\n   * @private\n   */\n  async driverExecuteQuery(queryArgs: queryArgsType): Promise<Object> {\n    const runQuery = (connection: connectionType, { executionType, text }) =>\n      new Promise((resolve, reject) => {\n        const method = this.resolveExecutionType(executionType);\n        // Callback used by node-sqlite3 to return results of query\n        function queryCallback(err?: Error, data?: Object) {\n          if (err) {\n            return reject(err);\n          }\n          return resolve({\n            data,\n            lastID: this.lastID,\n            changes: this.changes\n          });\n        }\n\n        switch (method) {\n          case 'run': {\n            return connection.run(text, queryArgs.params || [], queryCallback);\n          }\n          case 'all': {\n            return connection.all(text, queryArgs.params || [], queryCallback);\n          }\n          default: {\n            throw new Error(`Unknown connection method \"${method}\"`);\n          }\n        }\n      });\n\n    // Called in runWithConnection. connection is the node-sqlite3 db object\n    const identifyStatementsRunQuery = async (connection: connectionType) => {\n      const statements = this.identifyCommands(queryArgs.query);\n      const results = statements.map(statement =>\n        runQuery(connection, statement).then(result => ({\n          ...result,\n          statement\n        }))\n      );\n\n      return queryArgs.multiple\n        ? Promise.all(results)\n        : Promise.resolve(results[0]);\n    };\n\n    return this.connection.connection\n      ? identifyStatementsRunQuery(this.connection.connection)\n      : this.runWithConnection(identifyStatementsRunQuery);\n  }\n\n  runWithConnection(run: () => Promise<Array<Object>>): Promise<void> {\n    return new Promise((resolve, reject) => {\n      sqlite3.verbose();\n\n      const db = new sqlite3.Database(\n        this.connection.dbConfig.database,\n        async err => {\n          if (err) {\n            return reject(err);\n          }\n\n          // duration is given in nanoseconds\n          db.on('profile', (query, duration) => {\n            this.logs.push({\n              query,\n              duration,\n              type: 'profile'\n            });\n          });\n\n          let failed = false;\n          let fn = () => {};\n\n          try {\n            db.serialize();\n            return resolve(run(db));\n          } catch (runErr) {\n            failed = true;\n            fn = reject(runErr);\n          } finally {\n            db.close();\n          }\n\n          if (failed) {\n            return fn();\n          }\n          return true;\n        }\n      );\n    });\n  }\n\n  /**\n   * @private\n   */\n  resolveExecutionType(executionType: string): 'run' | 'all' {\n    switch (executionType) {\n      case 'MODIFICATION':\n        return 'run';\n      default:\n        return 'all';\n    }\n  }\n\n  /**\n   * @private\n   */\n  checkUnsupported(exportOptions: exportOptionsType) {\n    const unsupportedOptions = ['views', 'procedures', 'functions', 'rows'];\n    const hasUnsupported = Object.keys(exportOptions).some(option =>\n      unsupportedOptions.includes(option)\n    );\n\n    if (hasUnsupported) {\n      throw new Error(\n        `Unsupported properties passed: ${JSON.stringify(exportOptions)}`\n      );\n    }\n  }\n\n  getGraphQLServerPort() {\n    return this.graphQLServerPort;\n  }\n\n  async startGraphQLServer(): Promise<void> {\n    if (this.graphQLServerIsRunning()) {\n      return;\n    }\n\n    // See https://github.com/airbnb/babel-plugin-dynamic-import-node/issues/47\n    const [graphqlHTTP, tuql, express] = await Promise.all([\n      import('express-graphql').then(x => x.default || x),\n      import('@falcon-client/tuql').then(x => x.default || x),\n      import('express').then(x => x.default || x)\n    ]);\n\n    const { buildSchemaFromDatabase } = tuql;\n    const app = express();\n\n    const schema = await buildSchemaFromDatabase(\n      this.connection.dbConfig.database\n    );\n    const port = await getPort();\n    app.use('/graphql', cors(), graphqlHTTP({ schema }));\n\n    await new Promise(resolve => {\n      this.graphQLServer = app.listen(port, () => {\n        this.graphQLServerPort = port;\n        console.log(` > Running at http://localhost:${port}/graphql`);\n        resolve();\n      });\n      this.privateGraphQLServerIsRunning = true;\n    });\n  }\n\n  async stopGraphQLServer(): Promise<void> {\n    if (this.graphQLServerIsRunning()) {\n      this.graphQLServer.close();\n      this.graphQLServer = undefined;\n      this.graphQLServerPort = undefined;\n      this.privateGraphQLServerIsRunning = false;\n    }\n  }\n\n  graphQLServerIsRunning() {\n    return this.privateGraphQLServerIsRunning;\n  }\n}\n\nfunction configDatabase(server, database) {\n  return {\n    database: database.database\n  };\n}\n\nasync function SqliteFactory(\n  server: serverType,\n  database: databaseType\n): FactoryType {\n  const logger = createLogger('db:clients:sqlite');\n  const dbConfig = configDatabase(server, database);\n  const connection = { dbConfig };\n  logger().debug('create driver client for sqlite3 with config %j', dbConfig);\n\n  const provider = new SqliteProvider(server, database, connection);\n\n  // Light solution to test connection with with the server\n  await provider.driverExecuteQuery({ query: 'SELECT sqlite_version()' });\n\n  return provider;\n}\n\nexport default SqliteFactory;\n"]}